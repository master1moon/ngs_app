<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة كروت الشبكات اللاسلكية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/ar.min.js"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            direction: rtl;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            background: var(--primary-color);
            color: white;
            min-width: 250px;
            padding: 0;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .sidebar .logo {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.7);
            padding: 15px 20px;
            border-radius: 0;
            transition: all 0.3s;
            margin: 5px 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        
        .sidebar .nav-link:hover, 
        .sidebar .nav-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        
        .sidebar .nav-link i {
            margin-left: 10px;
            width: 20px;
            text-align: center;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header-bar {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px;
        }
        
        .page-title {
            font-weight: 700;
            color: var(--dark-color);
            margin: 0;
        }
        
        .section-content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--primary-color);
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--light-color);
            padding: 12px 15px;
            text-align: right;
            font-weight: 600;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .data-table tr:hover td {
            background: rgba(52, 152, 219, 0.05);
        }
        
        .action-buttons .btn {
            margin-left: 5px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-title {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .store-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .store-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .store-name {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-color);
        }
        
        .store-balance {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .balance-positive {
            color: var(--success-color);
        }
        
        .balance-negative {
            color: var(--accent-color);
        }
        
        .export-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .export-btn {
            flex: 1;
            min-width: 120px;
        }
        
        .currency::after {
            content: " ر.ي";
            font-family: inherit;
        }
        
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(44, 62, 80, 0.25);
            border-color: var(--primary-color);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #1a2530;
            border-color: #1a2530;
        }
        
        .package-img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .notification.success {
            background-color: var(--success-color);
        }
        
        .notification.error {
            background-color: var(--accent-color);
        }
        
        .notification.info {
            background-color: var(--secondary-color);
        }
        
        .formatted-number {
            text-align: left;
            direction: ltr;
            display: inline-block;
        }
        
        .profit-positive {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .profit-negative {
            color: var(--accent-color);
            font-weight: bold;
        }
        
        .partner-report-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .partner-report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .partner-report-title {
            font-weight: 700;
            color: var(--primary-color);
            margin: 0;
        }
        
        .partner-report-dates {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .partner-report-summary {
            display: flex;
            justify-content: space-around;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .summary-item {
            flex: 1;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                min-height: auto;
                width: 100%;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .export-btn {
                width: 100%;
            }
            
            .partner-report-summary {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- إشعارات النظام -->
    <div id="notification" class="notification">
        <i class="fas fa-check-circle me-2"></i>
        <span id="notificationText"></span>
    </div>

    <!-- لوحة التحكم الرئيسية -->
    <div class="app-container">
        <!-- الشريط الجانبي -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-network-wired fa-2x mb-2"></i>
                <h5>نظام كروت الشبكات</h5>
                <p class="text-white-50 small">الإصدار النهائي</p>
            </div>
            
            <ul class="nav flex-column mt-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-section="dashboard">
                        <i class="fas fa-home"></i> لوحة التحكم
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="packages">
                        <i class="fas fa-box"></i> الباقات والأسعار
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="inventory">
                        <i class="fas fa-cubes"></i> كمية الكروت
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="stores">
                        <i class="fas fa-store"></i> البقالات والمحلات
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="expenses">
                        <i class="fas fa-money-bill-wave"></i> المصروفات
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="reports">
                        <i class="fas fa-chart-bar"></i> التقارير
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-section="importExport">
                        <i class="fas fa-exchange-alt"></i> الاستيراد والتصدير
                    </a>
                </li>
            </ul>
        </div>

        <!-- المحتوى الرئيسي -->
        <div class="main-content">
            <!-- شريط العنوان -->
            <div class="header-bar">
                <h2 class="page-title">لوحة التحكم</h2>
                <div>
                    <span id="currentDate" class="text-muted me-3"></span>
                    <span class="badge bg-primary">
                        <i class="fas fa-user me-1"></i> مدير النظام
                    </span>
                </div>
            </div>

            <!-- لوحة التحكم -->
            <div id="dashboard" class="section">
                <div class="stats-container">
                    <div class="stat-box">
                        <div class="stat-title">عدد الباقات</div>
                        <div id="packagesCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">إجمالي الكروت</div>
                        <div id="totalCards" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">عدد المحلات</div>
                        <div id="storesCount" class="stat-value">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">إجمالي المبيعات</div>
                        <div id="totalSales" class="stat-value currency">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-title">صافي الأرباح</div>
                        <div id="netProfit" class="stat-value currency">0</div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="section-content">
                            <h4 class="section-title">أحدث الباقات</h4>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>اسم الباقة</th>
                                            <th>سعر التجزئة</th>
                                            <th>سعر الجملة</th>
                                            <th>سعر الموزعين</th>
                                            <th>الكمية</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recentPackages">
                                        <!-- سيتم ملؤه بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="section-content">
                            <h4 class="section-title">أحدث المحلات</h4>
                            <div id="recentStores" class="store-list">
                                <!-- سيتم ملؤه بالبيانات -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم الباقات والأسعار -->
            <div id="packages" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">إدارة الباقات والأسعار
                        <button class="btn btn-primary" id="addPackageBtn">
                            <i class="fas fa-plus me-2"></i>إضافة باقة جديدة
                        </button>
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>صورة الباقة</th>
                                    <th>اسم الباقة</th>
                                    <th>سعر التجزئة</th>
                                    <th>سعر الجملة</th>
                                    <th>سعر الموزعين</th>
                                    <th>تاريخ الإضافة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTable">
                                <!-- سيتم ملؤه بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- قسم كمية الكروت -->
            <div id="inventory" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">إدارة كمية الكروت
                        <button class="btn btn-primary" id="addInventoryBtn">
                            <i class="fas fa-plus me-2"></i>إضافة كمية جديدة
                        </button>
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>اسم الباقة</th>
                                    <th>الكمية المتوفرة</th>
                                    <th>إجمالي القيمة (تجزئة)</th>
                                    <th>إجمالي القيمة (جملة)</th>
                                    <th>إجمالي القيمة (موزعين)</th>
                                    <th>تاريخ الإضافة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable">
                                <!-- سيتم ملؤه بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- قسم البقالات والمحلات -->
            <div id="stores" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">إدارة البقالات والمحلات
                        <button class="btn btn-primary" id="addStoreBtn">
                            <i class="fas fa-plus me-2"></i>إضافة محل جديد
                        </button>
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div id="storesList" class="list-group">
                                <!-- سيتم ملؤه بالبيانات -->
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div id="storeHeader" class="card-header bg-primary text-white">
                                    اختر محلًا لعرض التفاصيل
                                </div>
                                <div class="card-body">
                                    <div id="storeDetails">
                                        <div class="text-center py-5">
                                            <i class="fas fa-store fa-3x text-muted mb-3"></i>
                                            <p>اختر محلًا من القائمة لعرض التفاصيل</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- قسم المصروفات -->
            <div id="expenses" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">إدارة المصروفات
                        <button class="btn btn-primary" id="addExpenseBtn">
                            <i class="fas fa-plus me-2"></i>إضافة مصروف جديد
                        </button>
                    </h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    إجمالي المصروفات (شهر <span id="currentMonth"></span>)
                                </div>
                                <div class="card-body">
                                    <p id="totalExpenses" class="h2 text-center currency">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    تصفية المصروفات حسب التاريخ
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label">من تاريخ</label>
                                            <input type="date" id="expenseFromDate" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">إلى تاريخ</label>
                                            <input type="date" id="expenseToDate" class="form-control">
                                        </div>
                                        <div class="col-12 mt-3">
                                            <button class="btn btn-primary w-100" id="filterExpensesBtn">تطبيق التصفية</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>نوع المصروف</th>
                                    <th>المبلغ</th>
                                    <th>ملاحظات</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="expensesTable">
                                <!-- سيتم ملؤه بالبيانات -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="export-options mt-4">
                        <button class="btn btn-outline-success export-btn" data-type="expenses" data-format="excel">
                            <i class="fas fa-file-excel me-2"></i>تصدير Excel
                        </button>
                        <button class="btn btn-outline-secondary export-btn" data-type="expenses" data-format="txt">
                            <i class="fas fa-file-alt me-2"></i>تصدير TXT
                        </button>
                        <button class="btn btn-outline-dark export-btn" data-type="expenses" data-format="json">
                            <i class="fas fa-file-code me-2"></i>تصدير JSON
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- قسم التقارير -->
            <div id="reports" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">التقارير المالية</h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    تصفية التقارير
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">اختر المحل</label>
                                            <select id="reportStoreSelect" class="form-select">
                                                <option value="all">جميع المحلات</option>
                                                <!-- سيتم ملؤه بالبيانات -->
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">من تاريخ</label>
                                            <input type="date" id="reportFromDate" class="form-control">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">إلى تاريخ</label>
                                            <input type="date" id="reportToDate" class="form-control">
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" id="generateReportBtn">توليد التقرير</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    إجمالي الديون
                                </div>
                                <div class="card-body d-flex flex-column justify-content-center">
                                    <p id="totalDebts" class="h2 text-center currency">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            تقرير الديون للمحلات
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>اسم المحل</th>
                                            <th>إجمالي المبيعات</th>
                                            <th>المدفوع</th>
                                            <th>المتبقي</th>
                                            <th>نوع السعر</th>
                                            <th>آخر عملية</th>
                                        </tr>
                                    </thead>
                                    <tbody id="debtReportTable">
                                        <!-- سيتم ملؤه بالبيانات -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            تقرير الأرباح والخسائر
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>الوصف</th>
                                            <th>المبلغ</th>
                                            <th>التفاصيل</th>
                                        </tr>
                                    </thead>
                                    <tbody id="profitReportTable">
                                        <tr>
                                            <td>إجمالي المبيعات</td>
                                            <td id="totalSalesReport" class="currency">0</td>
                                            <td>مجموع مبيعات الكروت لجميع المحلات</td>
                                        </tr>
                                        <tr>
                                            <td>إجمالي المصروفات</td>
                                            <td id="totalExpensesReport" class="currency">0</td>
                                            <td>مجموع المصروفات المسجلة في النظام</td>
                                        </tr>
                                        <tr>
                                            <td>صافي الربح/الخسارة</td>
                                            <td id="netProfitReport" class="currency">0</td>
                                            <td>الفرق بين إجمالي المبيعات والمصروفات</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            تقارير الشركاء
                        </div>
                        <div class="card-body">
                            <div id="partnerReportsContainer">
                                <!-- سيتم ملؤه بالبيانات -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="export-options mt-4">
                        <button class="btn btn-outline-success export-btn" data-type="reports" data-format="excel">
                            <i class="fas fa-file-excel me-2"></i>تصدير Excel
                        </button>
                        <button class="btn btn-outline-secondary export-btn" data-type="reports" data-format="txt">
                            <i class="fas fa-file-alt me-2"></i>تصدير TXT
                        </button>
                        <button class="btn btn-outline-dark export-btn" data-type="reports" data-format="json">
                            <i class="fas fa-file-code me-2"></i>تصدير JSON
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- قسم الاستيراد والتصدير -->
            <div id="importExport" class="section" style="display:none;">
                <div class="section-content">
                    <h4 class="section-title">الاستيراد والتصدير</h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-primary text-white">
                                    تصدير البيانات
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">اختر نوع البيانات للتصدير</label>
                                        <select id="exportDataType" class="form-select">
                                            <option value="all">جميع البيانات</option>
                                            <option value="packages">الباقات والأسعار</option>
                                            <option value="inventory">كمية الكروت</option>
                                            <option value="stores">البقالات والمحلات</option>
                                            <option value="expenses">المصروفات</option>
                                            <option value="reports">التقارير</option>
                                            <option value="sales">المبيعات</option>
                                            <option value="payments">التسديدات</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">اختر صيغة التصدير</label>
                                        <select id="exportFormat" class="form-select">
                                            <option value="json">JSON (للاستيراد لاحقاً)</option>
                                            <option value="excel">Excel</option>
                                            <option value="txt">TXT</option>
                                        </select>
                                    </div>
                                    
                                    <button id="exportDataBtn" class="btn btn-success w-100">
                                        <i class="fas fa-download me-2"></i>تصدير البيانات
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    استيراد البيانات
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">اختر ملف البيانات (JSON)</label>
                                        <input id="importFile" type="file" class="form-control">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">نوع البيانات المستوردة</label>
                                        <select id="importDataType" class="form-select">
                                            <option value="all">جميع البيانات</option>
                                            <option value="packages">الباقات والأسعار</option>
                                            <option value="inventory">كمية الكروت</option>
                                            <option value="stores">البقالات والمحلات</option>
                                            <option value="expenses">المصروفات</option>
                                            <option value="sales">المبيعات</option>
                                            <option value="payments">التسديدات</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="replaceData">
                                        <label class="form-check-label" for="replaceData">
                                            استبدال البيانات الحالية
                                        </label>
                                    </div>
                                    
                                    <button id="importDataBtn" class="btn btn-primary w-100">
                                        <i class="fas fa-upload me-2"></i>استيراد البيانات
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة باقة جديدة -->
    <div class="modal fade" id="packageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="packageModalTitle">إضافة باقة جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="packageForm">
                        <input type="hidden" id="packageId">
                        <div class="mb-3">
                            <label class="form-label">اسم الباقة *</label>
                            <input type="text" id="packageName" class="form-control" placeholder="أدخل اسم الباقة" required>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">سعر التجزئة (ر.ي)</label>
                                <input type="text" id="retailPrice" class="form-control formatted-input" placeholder="أدخل السعر">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">سعر الجملة (ر.ي)</label>
                                <input type="text" id="wholesalePrice" class="form-control formatted-input" placeholder="أدخل السعر">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">سعر الموزعين (ر.ي)</label>
                                <input type="text" id="distributorPrice" class="form-control formatted-input" placeholder="أدخل السعر">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">صورة الباقة (اختياري)</label>
                            <input type="file" id="packageImage" class="form-control" accept="image/*">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ الإضافة</label>
                            <input type="date" id="packageDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="savePackageBtn">حفظ الباقة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة كمية جديدة -->
    <div class="modal fade" id="inventoryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="inventoryModalTitle">إضافة كمية جديدة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="inventoryForm">
                        <input type="hidden" id="inventoryId">
                        <div class="mb-3">
                            <label class="form-label">اختر الباقة *</label>
                            <select id="inventoryPackage" class="form-select" required>
                                <!-- سيتم ملؤه بالبيانات -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">الكمية *</label>
                            <input type="text" id="inventoryQuantity" class="form-control formatted-input" placeholder="أدخل الكمية" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ الإضافة</label>
                            <input type="date" id="inventoryDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveInventoryBtn">حفظ الكمية</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة محل جديد -->
    <div class="modal fade" id="storeModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="storeModalTitle">إضافة محل جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="storeForm">
                        <input type="hidden" id="storeId">
                        <div class="mb-3">
                            <label class="form-label">اسم المحل *</label>
                            <input type="text" id="storeName" class="form-control" placeholder="أدخل اسم المحل" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">نوع السعر *</label>
                            <select id="storePriceType" class="form-select" required>
                                <option value="retail">سعر التجزئة</option>
                                <option value="wholesale">سعر الجملة</option>
                                <option value="distributor">سعر الموزعين</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ الإضافة</label>
                            <input type="date" id="storeDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveStoreBtn">حفظ المحل</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة مصروف جديد -->
    <div class="modal fade" id="expenseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="expenseModalTitle">إضافة مصروف جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <input type="hidden" id="expenseId">
                        <div class="mb-3">
                            <label class="form-label">نوع المصروف *</label>
                            <input list="expenseTypes" id="expenseType" class="form-control" required>
                            <datalist id="expenseTypes">
                                <option value="كهرباء">
                                <option value="انترنت ADSL">
                                <option value="انترنت فايبر">
                                <option value="انترنت ستار لينك">
                                <option value="صيانة">
                                <option value="سويتش">
                                <option value="كيبل كهرباء">
                                <option value="كيبل انترنت رئيسي">
                                <option value="كيبل انترنت منزلي">
                                <option value="مواصلات">
                                <option value="عامل">
                                <option value="ايجار سطوح">
                                <option value="أخرى">
                            </datalist>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">المبلغ (ر.ي)</label>
                            <input type="text" id="expenseAmount" class="form-control formatted-input" placeholder="أدخل المبلغ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ملاحظات (اختياري)</label>
                            <textarea id="expenseNotes" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ المصروف</label>
                            <input type="date" id="expenseDate" class="form-control">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="addLater">
                            <label class="form-check-label" for="addLater">
                                إضافة المبلغ لاحقًا
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveExpenseBtn">حفظ المصروف</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة بيع -->
    <div class="modal fade" id="saleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saleModalTitle">إضافة بيع</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saleForm">
                        <input type="hidden" id="saleId">
                        <input type="hidden" id="saleStoreId">
                        <div class="mb-3">
                            <label class="form-label">اختر الباقة</label>
                            <select id="salePackage" class="form-select">
                                <option value="">اختر الباقة</option>
                                <option value="custom">مخصص (مبلغ مباشر)</option>
                                <!-- سيتم ملؤه بالبيانات -->
                            </select>
                            <div class="form-text text-muted">اختياري - يمكنك إدخال سبب مخصص بدلاً من ذلك</div>
                        </div>
                        <div class="mb-3" id="customReasonGroup" style="display:none;">
                            <label class="form-label">السبب المخصص *</label>
                            <input type="text" id="saleReason" class="form-control" placeholder="أدخل السبب (مثال: دين سابق، فاتورة سابقة)">
                        </div>
                        <div class="mb-3" id="quantityGroup">
                            <label class="form-label">الكمية *</label>
                            <input type="text" id="saleQuantity" class="form-control formatted-input" placeholder="أدخل الكمية">
                        </div>
                        <div class="mb-3" id="amountGroup" style="display:none;">
                            <label class="form-label">المبلغ (ر.ي) *</label>
                            <input type="text" id="saleAmount" class="form-control formatted-input" placeholder="أدخل المبلغ">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ البيع</label>
                            <input type="date" id="saleDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="saveSaleBtn">حفظ البيع</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal لإضافة تسديد -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalTitle">إضافة تسديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="paymentId">
                        <input type="hidden" id="paymentStoreId">
                        <div class="mb-3">
                            <label class="form-label">المبلغ (ر.ي) *</label>
                            <input type="text" id="paymentAmount" class="form-control formatted-input" placeholder="أدخل المبلغ" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ملاحظات (اختياري)</label>
                            <textarea id="paymentNotes" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">تاريخ التسديد</label>
                            <input type="date" id="paymentDate" class="form-control">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="savePaymentBtn">حفظ التسديد</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // تهيئة التواريخ باللغة العربية
        moment.locale('ar');
        const today = moment().format('YYYY-MM-DD');
        document.getElementById('currentDate').textContent = moment().format('dddd، D MMMM YYYY');
        document.getElementById('currentMonth').textContent = moment().format('MMMM');
        
        // هياكل البيانات الأساسية
        let data = {
            packages: [],
            inventory: [],
            stores: [],
            expenses: [],
            sales: [],
            payments: []
        };
        
        // تنسيق الأرقام بفواصل كل ثلاثة أرقام
        function formatNumber(num) {
            if (num === null || num === undefined) return '';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // تحويل الأرقام المنسقة إلى أرقام صحيحة
        function parseFormattedNumber(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/,/g, ''));
        }
        
        // تطبيق تنسيق الأرقام على جميع حقول الإدخال
        function setupFormattedInputs() {
            document.querySelectorAll('.formatted-input').forEach(input => {
                // عند التركيز على الحقل، إزالة التنسيق
                input.addEventListener('focus', function() {
                    this.value = this.value.replace(/,/g, '');
                });
                
                // عند الخروج من الحقل، تطبيق التنسيق
                input.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = formatNumber(parseFormattedNumber(this.value));
                    }
                });
            });
        }
        
        // استرجاع البيانات من localStorage إن وجدت
        function loadData() {
            const savedData = localStorage.getItem('networkCardsData');
            if (savedData) {
                data = JSON.parse(savedData);
                showNotification('تم تحميل البيانات بنجاح', 'success');
            }
            updateDashboard();
            renderPackagesTable();
            renderInventoryTable();
            renderStoresList();
            renderExpensesTable();
            updateReportStores();
            updateProfitReport();
            generateDebtReport();
        }
        
        // حفظ البيانات إلى localStorage
        function saveData() {
            localStorage.setItem('networkCardsData', JSON.stringify(data));
            showNotification('تم حفظ البيانات بنجاح', 'success');
        }
        
        // تحديث لوحة التحكم
        function updateDashboard() {
            // تحديث الإحصائيات
            document.getElementById('packagesCount').textContent = data.packages.length;
            document.getElementById('storesCount').textContent = data.stores.length;
            
            // حساب إجمالي الكروت
            const totalCards = data.inventory.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('totalCards').textContent = formatNumber(totalCards);
            
            // حساب إجمالي المبيعات
            const totalSales = data.sales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('totalSales').textContent = formatNumber(totalSales);
            
            // حساب صافي الأرباح
            const totalExpenses = data.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalSales - totalExpenses;
            document.getElementById('netProfit').textContent = formatNumber(netProfit);
            
            // تحديث أحدث الباقات
            const recentPackages = document.getElementById('recentPackages');
            recentPackages.innerHTML = '';
            const packagesToShow = data.packages.slice(-3).reverse();
            
            packagesToShow.forEach(pkg => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pkg.name}</td>
                    <td class="currency">${pkg.retailPrice ? formatNumber(pkg.retailPrice) : '-'}</td>
                    <td class="currency">${pkg.wholesalePrice ? formatNumber(pkg.wholesalePrice) : '-'}</td>
                    <td class="currency">${pkg.distributorPrice ? formatNumber(pkg.distributorPrice) : '-'}</td>
                    <td>${formatNumber(data.inventory.filter(i => i.packageId === pkg.id).reduce((sum, i) => sum + i.quantity, 0))}</td>
                `;
                recentPackages.appendChild(row);
            });
            
            // تحديث أحدث المحلات
            const recentStores = document.getElementById('recentStores');
            recentStores.innerHTML = '';
            const storesToShow = data.stores.slice(-3).reverse();
            
            storesToShow.forEach(store => {
                const card = document.createElement('div');
                card.className = 'store-card';
                card.innerHTML = `
                    <div class="store-name">${store.name}</div>
                    <div class="store-balance">نوع السعر: ${getPriceTypeName(store.priceType)}</div>
                `;
                recentStores.appendChild(card);
            });
        }
        
        // الحصول على اسم نوع السعر
        function getPriceTypeName(priceType) {
            switch(priceType) {
                case 'retail': return 'تجزئة';
                case 'wholesale': return 'جملة';
                case 'distributor': return 'موزعين';
                default: return 'غير معروف';
            }
        }
        
        // تحديث تقرير الأرباح
        function updateProfitReport() {
            // حساب إجمالي المبيعات
            const totalSales = data.sales.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById('totalSalesReport').textContent = formatNumber(totalSales);
            
            // حساب إجمالي المصروفات
            const totalExpenses = data.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpensesReport').textContent = formatNumber(totalExpenses);
            
            // حساب صافي الربح
            const netProfit = totalSales - totalExpenses;
            const netProfitElement = document.getElementById('netProfitReport');
            netProfitElement.textContent = formatNumber(netProfit);
            netProfitElement.className = netProfit >= 0 ? 'currency profit-positive' : 'currency profit-negative';
        }
        
        // توليد تقارير الشركاء
        function generatePartnerReports() {
            const container = document.getElementById('partnerReportsContainer');
            container.innerHTML = '';
            
            // تاريخ التقرير
            const fromDate = document.getElementById('reportFromDate').value || moment().startOf('month').format('YYYY-MM-DD');
            const toDate = document.getElementById('reportToDate').value || moment().format('YYYY-MM-DD');
            
            // حساب إجمالي المبيعات
            const totalSales = data.sales.reduce((sum, sale) => {
                if (sale.date >= fromDate && sale.date <= toDate) {
                    return sum + sale.total;
                }
                return sum;
            }, 0);
            
            // حساب إجمالي المصروفات
            const totalExpenses = data.expenses.reduce((sum, expense) => {
                if (expense.date >= fromDate && expense.date <= toDate) {
                    return sum + expense.amount;
                }
                return sum;
            }, 0);
            
            // حساب صافي الربح
            const netProfit = totalSales - totalExpenses;
            
            const report = document.createElement('div');
            report.className = 'partner-report-card';
            report.innerHTML = `
                <div class="partner-report-header">
                    <h5 class="partner-report-title">تقرير أداء الشركاء</h5>
                    <div class="partner-report-dates">
                        من ${moment(fromDate).format('D MMMM YYYY')} إلى ${moment(toDate).format('D MMMM YYYY')}
                    </div>
                </div>
                
                <div class="partner-report-summary">
                    <div class="summary-item">
                        <div class="summary-value currency">${formatNumber(totalSales)}</div>
                        <div class="summary-label">إجمالي المبيعات</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value currency">${formatNumber(totalExpenses)}</div>
                        <div class="summary-label">إجمالي المصروفات</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value currency ${netProfit >= 0 ? 'profit-positive' : 'profit-negative'}">${formatNumber(netProfit)}</div>
                        <div class="summary-label">صافي الربح</div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>نوع الإيراد/المصروف</th>
                                <th>المبلغ</th>
                                <th>التفاصيل</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.sales.filter(sale => sale.date >= fromDate && sale.date <= toDate).map(sale => `
                                <tr>
                                    <td>بيع</td>
                                    <td class="currency">${formatNumber(sale.total)}</td>
                                    <td>${sale.reason || (sale.packageId ? 'بيع باقة' : 'بيع مخصص')}</td>
                                    <td>${sale.date}</td>
                                </tr>
                            `).join('')}
                            
                            ${data.expenses.filter(expense => expense.date >= fromDate && expense.date <= toDate).map(expense => `
                                <tr>
                                    <td>مصروف</td>
                                    <td class="currency">${formatNumber(expense.amount)}</td>
                                    <td>${expense.type}</td>
                                    <td>${expense.date}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-success" onclick="exportPartnerReport()">
                        <i class="fas fa-download me-2"></i>تصدير تقرير الشركاء
                    </button>
                </div>
            `;
            
            container.appendChild(report);
        }
        
        // تصدير تقرير الشركاء
        function exportPartnerReport() {
            // تاريخ التقرير
            const fromDate = document.getElementById('reportFromDate').value || moment().startOf('month').format('YYYY-MM-DD');
            const toDate = document.getElementById('reportToDate').value || moment().format('YYYY-MM-DD');
            
            // حساب إجمالي المبيعات
            const totalSales = data.sales.reduce((sum, sale) => {
                if (sale.date >= fromDate && sale.date <= toDate) {
                    return sum + sale.total;
                }
                return sum;
            }, 0);
            
            const totalExpenses = data.expenses.reduce((sum, expense) => {
                if (expense.date >= fromDate && expense.date <= toDate) {
                    return sum + expense.amount;
                }
                return sum;
            }, 0);
            
            const netProfit = totalSales - totalExpenses;
            
            // إنشاء بيانات التقرير
            const reportData = {
                fromDate: fromDate,
                toDate: toDate,
                totalSales: totalSales,
                totalExpenses: totalExpenses,
                netProfit: netProfit,
                sales: data.sales.filter(sale => sale.date >= fromDate && sale.date <= toDate),
                expenses: data.expenses.filter(expense => expense.date >= fromDate && expense.date <= toDate)
            };
            
            // اسم الملف مع تاريخ اليوم
            const filename = `تقرير_الشركاء_${moment().format('YYYYMMDD')}.json`;
            
            // إنشاء ملف JSON وتنزيله
            const dataStr = JSON.stringify(reportData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('تم تصدير تقرير الشركاء بنجاح', 'success');
        }
        
        // عرض جدول الباقات
        function renderPackagesTable() {
            const table = document.getElementById('packagesTable');
            table.innerHTML = '';
            
            data.packages.forEach(pkg => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${pkg.image || 'https://via.placeholder.com/60'}" class="package-img"></td>
                    <td>${pkg.name}</td>
                    <td class="currency">${pkg.retailPrice ? formatNumber(pkg.retailPrice) : '-'}</td>
                    <td class="currency">${pkg.wholesalePrice ? formatNumber(pkg.wholesalePrice) : '-'}</td>
                    <td class="currency">${pkg.distributorPrice ? formatNumber(pkg.distributorPrice) : '-'}</td>
                    <td>${pkg.createdAt}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-package" data-id="${pkg.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-package" data-id="${pkg.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                table.appendChild(row);
            });
            
            // إضافة معالجات الأحداث للأزرار
            document.querySelectorAll('.edit-package').forEach(btn => {
                btn.addEventListener('click', () => editPackage(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-package').forEach(btn => {
                btn.addEventListener('click', () => deletePackage(btn.dataset.id));
            });
        }
        
        // عرض جدول المخزون
        function renderInventoryTable() {
            const table = document.getElementById('inventoryTable');
            table.innerHTML = '';
            
            data.inventory.forEach(item => {
                const pkg = data.packages.find(p => p.id === item.packageId);
                if (!pkg) return;
                
                const retailValue = item.quantity * (pkg.retailPrice || 0);
                const wholesaleValue = item.quantity * (pkg.wholesalePrice || 0);
                const distributorValue = item.quantity * (pkg.distributorPrice || 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${pkg.name}</td>
                    <td>${formatNumber(item.quantity)}</td>
                    <td class="currency">${formatNumber(retailValue)}</td>
                    <td class="currency">${formatNumber(wholesaleValue)}</td>
                    <td class="currency">${formatNumber(distributorValue)}</td>
                    <td>${item.createdAt}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-inventory" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-inventory" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                table.appendChild(row);
            });
            
            // إضافة معالجات الأحداث للأزرار
            document.querySelectorAll('.edit-inventory').forEach(btn => {
                btn.addEventListener('click', () => editInventory(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-inventory').forEach(btn => {
                btn.addEventListener('click', () => deleteInventory(btn.dataset.id));
            });
        }
        
        // عرض قائمة المحلات
        function renderStoresList() {
            const list = document.getElementById('storesList');
            list.innerHTML = '';
            
            data.stores.forEach(store => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.dataset.id = store.id;
                item.innerHTML = `
                    <div>${store.name}</div>
                    <small class="text-muted">نوع السعر: ${getPriceTypeName(store.priceType)}</small>
                `;
                item.addEventListener('click', () => showStoreDetails(store.id));
                list.appendChild(item);
            });
        }
        
        // عرض تفاصيل المحل
        function showStoreDetails(storeId) {
            const store = data.stores.find(s => s.id === storeId);
            if (!store) return;
            
            document.getElementById('storeHeader').textContent = `تفاصيل المحل: ${store.name}`;
            const details = document.getElementById('storeDetails');
            
            // حساب الرصيد
            const sales = data.sales.filter(s => s.storeId === storeId);
            const payments = data.payments.filter(p => p.storeId === storeId);
            
            const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalPayments = payments.reduce((sum, payment) => sum + payment.amount, 0);
            const balance = totalSales - totalPayments;
            
            details.innerHTML = `
                <div class="d-flex justify-content-between mb-4">
                    <div>
                        <h5>الرصيد الحالي:</h5>
                        <p class="h4 ${balance >= 0 ? 'text-success' : 'text-danger'} currency">${formatNumber(Math.abs(balance))}</p>
                    </div>
                    <div>
                        <h5>نوع السعر:</h5>
                        <p class="h5">${getPriceTypeName(store.priceType)}</p>
                    </div>
                    <div>
                        <button class="btn btn-success" id="addSaleBtn" data-store="${storeId}"><i class="fas fa-plus me-2"></i>إضافة بيع</button>
                        <button class="btn btn-info" id="addPaymentBtn" data-store="${storeId}"><i class="fas fa-money-bill me-2"></i>تسديد دفعة</button>
                        <button class="btn btn-warning edit-store" data-id="${storeId}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger delete-store" data-id="${storeId}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                
                <h5>عمليات البيع</h5>
                <div class="table-responsive mb-4">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>السبب/الباقة</th>
                                <th>الكمية/المبلغ</th>
                                <th>الإجمالي</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="storeSalesTable">
                            <!-- سيتم ملؤه بالبيانات -->
                        </tbody>
                    </table>
                </div>
                
                <h5>عمليات التسديد</h5>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>المبلغ</th>
                                <th>ملاحظات</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="storePaymentsTable">
                            <!-- سيتم ملؤه بالبيانات -->
                        </tbody>
                    </table>
                </div>
                
                <div class="export-options mt-4">
                    <button class="btn btn-outline-success export-btn" data-type="store" data-store="${storeId}" data-format="excel">
                        <i class="fas fa-file-excel me-2"></i>تصدير Excel
                    </button>
                    <button class="btn btn-outline-secondary export-btn" data-type="store" data-store="${storeId}" data-format="txt">
                        <i class="fas fa-file-alt me-2"></i>تصدير TXT
                    </button>
                    <button class="btn btn-outline-dark export-btn" data-type="store" data-store="${storeId}" data-format="json">
                        <i class="fas fa-file-code me-2"></i>تصدير JSON
                    </button>
                </div>
            `;
            
            // تعبئة جدول المبيعات
            const salesTable = document.getElementById('storeSalesTable');
            salesTable.innerHTML = '';
            sales.forEach(sale => {
                const pkg = sale.packageId ? data.packages.find(p => p.id === sale.packageId) : null;
                const isCustom = sale.packageId === 'custom';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${sale.date}</td>
                    <td>${sale.reason || (pkg ? pkg.name : 'غير معروف')}</td>
                    <td>${isCustom ? formatNumber(sale.amount) + ' ر.ي' : sale.quantity}</td>
                    <td class="currency">${formatNumber(sale.total)}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-sale" data-id="${sale.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-sale" data-id="${sale.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                salesTable.appendChild(row);
            });
            
            // تعبئة جدول التسديدات
            const paymentsTable = document.getElementById('storePaymentsTable');
            paymentsTable.innerHTML = '';
            payments.forEach(payment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${payment.date}</td>
                    <td class="currency">${formatNumber(payment.amount)}</td>
                    <td>${payment.notes || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-payment" data-id="${payment.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-payment" data-id="${payment.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                paymentsTable.appendChild(row);
            });
            
            // إضافة معالجات الأحداث للأزرار الجديدة
            document.getElementById('addSaleBtn').addEventListener('click', () => addSale(storeId));
            document.getElementById('addPaymentBtn').addEventListener('click', () => addPayment(storeId));
            
            document.querySelector('.edit-store').addEventListener('click', () => editStore(storeId));
            document.querySelector('.delete-store').addEventListener('click', () => deleteStore(storeId));
            
            document.querySelectorAll('.edit-sale').forEach(btn => {
                btn.addEventListener('click', () => editSale(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-sale').forEach(btn => {
                btn.addEventListener('click', () => deleteSale(btn.dataset.id));
            });
            
            document.querySelectorAll('.edit-payment').forEach(btn => {
                btn.addEventListener('click', () => editPayment(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-payment').forEach(btn => {
                btn.addEventListener('click', () => deletePayment(btn.dataset.id));
            });
        }
        
        // إضافة بيع جديد
        function addSale(storeId) {
            // تعبئة قائمة الباقات
            const select = document.getElementById('salePackage');
            select.innerHTML = '';
            select.innerHTML = '<option value="">اختر الباقة</option>';
            select.innerHTML += '<option value="custom">مخصص (مبلغ مباشر)</option>';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                select.appendChild(option);
            });
            
            // إضافة معالج الحدث لتغيير خيار الباقة
            select.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                document.getElementById('customReasonGroup').style.display = isCustom ? 'block' : 'none';
                document.getElementById('quantityGroup').style.display = isCustom ? 'none' : 'block';
                document.getElementById('amountGroup').style.display = isCustom ? 'block' : 'none';
                
                if (isCustom) {
                    document.getElementById('saleReason').value = '';
                    document.getElementById('saleAmount').value = '';
                } else {
                    document.getElementById('saleQuantity').value = '';
                }
            });
            
            document.getElementById('saleModalTitle').textContent = 'إضافة بيع';
            document.getElementById('saleId').value = '';
            document.getElementById('saleStoreId').value = storeId;
            document.getElementById('saleReason').value = '';
            document.getElementById('saleQuantity').value = '';
            document.getElementById('saleAmount').value = '';
            document.getElementById('saleDate').value = today;
            document.getElementById('customReasonGroup').style.display = 'none';
            document.getElementById('amountGroup').style.display = 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('saleModal'));
            modal.show();
        }
        
        // حفظ البيع
        function saveSale() {
            const id = document.getElementById('saleId').value;
            const storeId = document.getElementById('saleStoreId').value;
            const packageId = document.getElementById('salePackage').value;
            const reason = document.getElementById('saleReason').value;
            const quantity = parseFormattedNumber(document.getElementById('saleQuantity').value) || 0;
            const amount = parseFormattedNumber(document.getElementById('saleAmount').value) || 0;
            const date = document.getElementById('saleDate').value || today;
            
            if (!storeId || (!packageId && !reason)) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            const isCustom = packageId === 'custom';
            const store = data.stores.find(s => s.id === storeId);
            const pkg = packageId && !isCustom ? data.packages.find(p => p.id === packageId) : null;
            
            let pricePerUnit = 0;
            let total = 0;
            
            if (isCustom) {
                // بيع مخصص
                pricePerUnit = amount;
                total = amount;
            } else if (pkg && store) {
                // تحديد السعر حسب نوع سعر المحل
                switch(store.priceType) {
                    case 'retail':
                        pricePerUnit = pkg.retailPrice || 0;
                        break;
                    case 'wholesale':
                        pricePerUnit = pkg.wholesalePrice || 0;
                        break;
                    case 'distributor':
                        pricePerUnit = pkg.distributorPrice || 0;
                        break;
                    default:
                        pricePerUnit = pkg.retailPrice || 0;
                }
                total = quantity * pricePerUnit;
            }
            
            if (id) {
                // تحديث البيع الحالي
                const sale = data.sales.find(s => s.id === id);
                if (sale) {
                    sale.packageId = packageId;
                    sale.reason = reason;
                    sale.quantity = quantity;
                    sale.amount = amount;
                    sale.pricePerUnit = pricePerUnit;
                    sale.total = total;
                    sale.date = date;
                }
                showNotification('تم تحديث البيع بنجاح', 'success');
            } else {
                // إضافة بيع جديد
                const newId = 'sale_' + Date.now();
                data.sales.push({
                    id: newId,
                    storeId: storeId,
                    packageId: packageId,
                    reason: reason,
                    quantity: quantity,
                    amount: amount,
                    pricePerUnit: pricePerUnit,
                    total: total,
                    date: date
                });
                showNotification('تم إضافة البيع بنجاح', 'success');
            }
            
            saveData();
            showStoreDetails(storeId);
            updateDashboard();
            updateProfitReport();
            generateDebtReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('saleModal'));
            modal.hide();
        }
        
        // تحرير بيع
        function editSale(id) {
            const sale = data.sales.find(s => s.id === id);
            if (!sale) return;
            
            // تعبئة قائمة الباقات
            const select = document.getElementById('salePackage');
            select.innerHTML = '';
            select.innerHTML = '<option value="">اختر الباقة</option>';
            select.innerHTML += '<option value="custom">مخصص (مبلغ مباشر)</option>';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                option.selected = pkg.id === sale.packageId;
                select.appendChild(option);
            });
            
            // تحديد حالة الخيار المخصص
            const isCustom = sale.packageId === 'custom';
            if (isCustom) {
                select.value = 'custom';
            }
            
            // إضافة معالج الحدث لتغيير خيار الباقة
            select.addEventListener('change', function() {
                const isCustom = this.value === 'custom';
                document.getElementById('customReasonGroup').style.display = isCustom ? 'block' : 'none';
                document.getElementById('quantityGroup').style.display = isCustom ? 'none' : 'block';
                document.getElementById('amountGroup').style.display = isCustom ? 'block' : 'none';
                
                if (isCustom) {
                    document.getElementById('saleReason').value = sale.reason || '';
                    document.getElementById('saleAmount').value = formatNumber(sale.amount) || '';
                } else {
                    document.getElementById('saleQuantity').value = formatNumber(sale.quantity) || '';
                }
            });
            
            document.getElementById('saleModalTitle').textContent = 'تعديل البيع';
            document.getElementById('saleId').value = sale.id;
            document.getElementById('saleStoreId').value = sale.storeId;
            document.getElementById('saleReason').value = sale.reason || '';
            document.getElementById('saleQuantity').value = formatNumber(sale.quantity) || '';
            document.getElementById('saleAmount').value = formatNumber(sale.amount) || '';
            document.getElementById('saleDate').value = sale.date;
            document.getElementById('customReasonGroup').style.display = isCustom ? 'block' : 'none';
            document.getElementById('quantityGroup').style.display = isCustom ? 'none' : 'block';
            document.getElementById('amountGroup').style.display = isCustom ? 'block' : 'none';
            
            const modal = new bootstrap.Modal(document.getElementById('saleModal'));
            modal.show();
        }
        
        // حذف بيع
        function deleteSale(id) {
            const sale = data.sales.find(s => s.id === id);
            if (!sale) return;
            
            if (confirm('هل أنت متأكد من حذف هذا البيع؟')) {
                data.sales = data.sales.filter(s => s.id !== id);
                saveData();
                showStoreDetails(sale.storeId);
                updateDashboard();
                updateProfitReport();
                generateDebtReport();
                showNotification('تم حذف البيع بنجاح', 'success');
            }
        }
        
        // إضافة تسديد جديد
        function addPayment(storeId) {
            document.getElementById('paymentModalTitle').textContent = 'إضافة تسديد';
            document.getElementById('paymentId').value = '';
            document.getElementById('paymentStoreId').value = storeId;
            document.getElementById('paymentAmount').value = '';
            document.getElementById('paymentNotes').value = '';
            document.getElementById('paymentDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }
        
        // حفظ التسديد
        function savePayment() {
            const id = document.getElementById('paymentId').value;
            const storeId = document.getElementById('paymentStoreId').value;
            const amount = parseFormattedNumber(document.getElementById('paymentAmount').value);
            const notes = document.getElementById('paymentNotes').value;
            const date = document.getElementById('paymentDate').value || today;
            
            if (!storeId || isNaN(amount) || amount <= 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (id) {
                // تحديث التسديد الحالي
                const payment = data.payments.find(p => p.id === id);
                if (payment) {
                    payment.amount = amount;
                    payment.notes = notes;
                    payment.date = date;
                }
                showNotification('تم تحديث التسديد بنجاح', 'success');
            } else {
                // إضافة تسديد جديد
                const newId = 'payment_' + Date.now();
                data.payments.push({
                    id: newId,
                    storeId: storeId,
                    amount: amount,
                    notes: notes,
                    date: date
                });
                showNotification('تم إضافة التسديد بنجاح', 'success');
            }
            
            saveData();
            showStoreDetails(storeId);
            updateDashboard();
            updateProfitReport();
            generateDebtReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
        }
        
        // تحرير تسديد
        function editPayment(id) {
            const payment = data.payments.find(p => p.id === id);
            if (!payment) return;
            
            document.getElementById('paymentModalTitle').textContent = 'تعديل التسديد';
            document.getElementById('paymentId').value = payment.id;
            document.getElementById('paymentStoreId').value = payment.storeId;
            document.getElementById('paymentAmount').value = formatNumber(payment.amount);
            document.getElementById('paymentNotes').value = payment.notes || '';
            document.getElementById('paymentDate').value = payment.date;
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }
        
        // حذف تسديد
        function deletePayment(id) {
            const payment = data.payments.find(p => p.id === id);
            if (!payment) return;
            
            if (confirm('هل أنت متأكد من حذف هذا التسديد؟')) {
                data.payments = data.payments.filter(p => p.id !== id);
                saveData();
                showStoreDetails(payment.storeId);
                updateDashboard();
                updateProfitReport();
                generateDebtReport();
                showNotification('تم حذف التسديد بنجاح', 'success');
            }
        }
        
        // إضافة باقة جديدة
        function addPackage() {
            document.getElementById('packageModalTitle').textContent = 'إضافة باقة جديدة';
            document.getElementById('packageId').value = '';
            document.getElementById('packageName').value = '';
            document.getElementById('retailPrice').value = '';
            document.getElementById('wholesalePrice').value = '';
            document.getElementById('distributorPrice').value = '';
            document.getElementById('packageDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('packageModal'));
            modal.show();
        }
        
        // تحرير باقة موجودة
        function editPackage(id) {
            const pkg = data.packages.find(p => p.id === id);
            if (!pkg) return;
            
            document.getElementById('packageModalTitle').textContent = 'تعديل الباقة';
            document.getElementById('packageId').value = pkg.id;
            document.getElementById('packageName').value = pkg.name;
            document.getElementById('retailPrice').value = pkg.retailPrice ? formatNumber(pkg.retailPrice) : '';
            document.getElementById('wholesalePrice').value = pkg.wholesalePrice ? formatNumber(pkg.wholesalePrice) : '';
            document.getElementById('distributorPrice').value = pkg.distributorPrice ? formatNumber(pkg.distributorPrice) : '';
            document.getElementById('packageDate').value = pkg.createdAt || today;
            
            const modal = new bootstrap.Modal(document.getElementById('packageModal'));
            modal.show();
        }
        
        // حذف باقة
        function deletePackage(id) {
            if (confirm('هل أنت متأكد من حذف هذه الباقة؟')) {
                data.packages = data.packages.filter(p => p.id !== id);
                saveData();
                renderPackagesTable();
                updateDashboard();
                showNotification('تم حذف الباقة بنجاح', 'success');
            }
        }
        
        // حفظ الباقة (إضافة/تعديل)
        function savePackage() {
            const id = document.getElementById('packageId').value;
            const name = document.getElementById('packageName').value;
            const retailPrice = parseFormattedNumber(document.getElementById('retailPrice').value) || null;
            const wholesalePrice = parseFormattedNumber(document.getElementById('wholesalePrice').value) || null;
            const distributorPrice = parseFormattedNumber(document.getElementById('distributorPrice').value) || null;
            const date = document.getElementById('packageDate').value || today;
            
            if (!name) {
                showNotification('يرجى إدخال اسم الباقة', 'error');
                return;
            }
            
            if (id) {
                // تحديث الباقة الحالية
                const pkg = data.packages.find(p => p.id === id);
                if (pkg) {
                    pkg.name = name;
                    pkg.retailPrice = retailPrice;
                    pkg.wholesalePrice = wholesalePrice;
                    pkg.distributorPrice = distributorPrice;
                    pkg.createdAt = date;
                }
                showNotification('تم تحديث الباقة بنجاح', 'success');
            } else {
                // إضافة باقة جديدة
                const newId = 'pkg_' + Date.now();
                data.packages.push({
                    id: newId,
                    name: name,
                    retailPrice: retailPrice,
                    wholesalePrice: wholesalePrice,
                    distributorPrice: distributorPrice,
                    createdAt: date,
                    image: ''
                });
                showNotification('تم إضافة الباقة بنجاح', 'success');
            }
            
            saveData();
            renderPackagesTable();
            updateDashboard();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('packageModal'));
            modal.hide();
        }
        
        // إضافة كمية جديدة
        function addInventory() {
            // تعبئة قائمة الباقات
            const select = document.getElementById('inventoryPackage');
            select.innerHTML = '';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                select.appendChild(option);
            });
            
            document.getElementById('inventoryModalTitle').textContent = 'إضافة كمية جديدة';
            document.getElementById('inventoryId').value = '';
            document.getElementById('inventoryQuantity').value = '';
            document.getElementById('inventoryDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
            modal.show();
        }
        
        // تحرير كمية موجودة
        function editInventory(id) {
            const item = data.inventory.find(i => i.id === id);
            if (!item) return;
            
            // تعبئة قائمة الباقات
            const select = document.getElementById('inventoryPackage');
            select.innerHTML = '';
            data.packages.forEach(pkg => {
                const option = document.createElement('option');
                option.value = pkg.id;
                option.textContent = pkg.name;
                option.selected = pkg.id === item.packageId;
                select.appendChild(option);
            });
            
            document.getElementById('inventoryModalTitle').textContent = 'تعديل الكمية';
            document.getElementById('inventoryId').value = item.id;
            document.getElementById('inventoryQuantity').value = formatNumber(item.quantity);
            document.getElementById('inventoryDate').value = item.createdAt || today;
            
            const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
            modal.show();
        }
        
        // حذف كمية
        function deleteInventory(id) {
            if (confirm('هل أنت متأكد من حذف هذه الكمية؟')) {
                data.inventory = data.inventory.filter(i => i.id !== id);
                saveData();
                renderInventoryTable();
                updateDashboard();
                showNotification('تم حذف الكمية بنجاح', 'success');
            }
        }
        
        // حفظ الكمية (إضافة/تعديل)
        function saveInventory() {
            const id = document.getElementById('inventoryId').value;
            const packageId = document.getElementById('inventoryPackage').value;
            const quantity = parseFormattedNumber(document.getElementById('inventoryQuantity').value);
            const date = document.getElementById('inventoryDate').value || today;
            
            if (!packageId || isNaN(quantity) || quantity <= 0) {
                showNotification('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            if (id) {
                // تحديث الكمية الحالية
                const item = data.inventory.find(i => i.id === id);
                if (item) {
                    item.packageId = packageId;
                    item.quantity = quantity;
                    item.createdAt = date;
                }
                showNotification('تم تحديث الكمية بنجاح', 'success');
            } else {
                // إضافة كمية جديدة
                const newId = 'inv_' + Date.now();
                data.inventory.push({
                    id: newId,
                    packageId: packageId,
                    quantity: quantity,
                    createdAt: date
                });
                showNotification('تم إضافة الكمية بنجاح', 'success');
            }
            
            saveData();
            renderInventoryTable();
            updateDashboard();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryModal'));
            modal.hide();
        }
        
        // إضافة محل جديد
        function addStore() {
            document.getElementById('storeModalTitle').textContent = 'إضافة محل جديد';
            document.getElementById('storeId').value = '';
            document.getElementById('storeName').value = '';
            document.getElementById('storePriceType').value = 'retail';
            document.getElementById('storeDate').value = today;
            
            const modal = new bootstrap.Modal(document.getElementById('storeModal'));
            modal.show();
        }
        
        // تحرير محل موجود
        function editStore(id) {
            const store = data.stores.find(s => s.id === id);
            if (!store) return;
            
            document.getElementById('storeModalTitle').textContent = 'تعديل المحل';
            document.getElementById('storeId').value = store.id;
            document.getElementById('storeName').value = store.name;
            document.getElementById('storePriceType').value = store.priceType;
            document.getElementById('storeDate').value = store.createdAt || today;
            
            const modal = new bootstrap.Modal(document.getElementById('storeModal'));
            modal.show();
        }
        
        // حذف محل
        function deleteStore(id) {
            if (confirm('هل أنت متأكد من حذف هذا المحل؟')) {
                data.stores = data.stores.filter(s => s.id !== id);
                saveData();
                renderStoresList();
                updateDashboard();
                updateReportStores();
                generateDebtReport();
                showNotification('تم حذف المحل بنجاح', 'success');
            }
        }
        
        // حفظ المحل (إضافة/تعديل)
        function saveStore() {
            const id = document.getElementById('storeId').value;
            const name = document.getElementById('storeName').value;
            const priceType = document.getElementById('storePriceType').value;
            const date = document.getElementById('storeDate').value || today;
            
            if (!name) {
                showNotification('يرجى إدخال اسم المحل', 'error');
                return;
            }
            
            if (id) {
                // تحديث المحل الحالي
                const store = data.stores.find(s => s.id === id);
                if (store) {
                    store.name = name;
                    store.priceType = priceType;
                    store.createdAt = date;
                }
                showNotification('تم تحديث المحل بنجاح', 'success');
            } else {
                // إضافة محل جديد
                const newId = 'store_' + Date.now();
                data.stores.push({
                    id: newId,
                    name: name,
                    priceType: priceType,
                    createdAt: date
                });
                showNotification('تم إضافة المحل بنجاح', 'success');
            }
            
            saveData();
            renderStoresList();
            updateDashboard();
            updateReportStores();
            generateDebtReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('storeModal'));
            modal.hide();
        }
        
        // إضافة مصروف جديد
        function addExpense() {
            document.getElementById('expenseModalTitle').textContent = 'إضافة مصروف جديد';
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseType').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseNotes').value = '';
            document.getElementById('expenseDate').value = today;
            document.getElementById('addLater').checked = false;
            
            const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
            modal.show();
        }
        
        // تحرير مصروف موجود
        function editExpense(id) {
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) return;
            
            document.getElementById('expenseModalTitle').textContent = 'تعديل المصروف';
            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseType').value = expense.type;
            document.getElementById('expenseAmount').value = formatNumber(expense.amount);
            document.getElementById('expenseNotes').value = expense.notes || '';
            document.getElementById('expenseDate').value = expense.date || today;
            document.getElementById('addLater').checked = expense.addLater || false;
            
            const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
            modal.show();
        }
        
        // حذف مصروف
        function deleteExpense(id) {
            if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                data.expenses = data.expenses.filter(e => e.id !== id);
                saveData();
                renderExpensesTable();
                updateDashboard();
                updateProfitReport();
                showNotification('تم حذف المصروف بنجاح', 'success');
            }
        }
        
        // حفظ المصروف (إضافة/تعديل)
        function saveExpense() {
            const id = document.getElementById('expenseId').value;
            const type = document.getElementById('expenseType').value;
            const amount = parseFormattedNumber(document.getElementById('expenseAmount').value) || 0;
            const notes = document.getElementById('expenseNotes').value;
            const date = document.getElementById('expenseDate').value || today;
            const addLater = document.getElementById('addLater').checked;
            
            if (!type) {
                showNotification('يرجى إدخال نوع المصروف', 'error');
                return;
            }
            
            if (id) {
                // تحديث المصروف الحالي
                const expense = data.expenses.find(e => e.id === id);
                if (expense) {
                    expense.type = type;
                    expense.amount = amount;
                    expense.notes = notes;
                    expense.date = date;
                    expense.addLater = addLater;
                }
                showNotification('تم تحديث المصروف بنجاح', 'success');
            } else {
                // إضافة مصروف جديد
                const newId = 'exp_' + Date.now();
                data.expenses.push({
                    id: newId,
                    type: type,
                    amount: amount,
                    notes: notes,
                    date: date,
                    addLater: addLater
                });
                showNotification('تم إضافة المصروف بنجاح', 'success');
            }
            
            saveData();
            renderExpensesTable();
            updateDashboard();
            updateProfitReport();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('expenseModal'));
            modal.hide();
        }
        
        // عرض جدول المصروفات
        function renderExpensesTable() {
            const table = document.getElementById('expensesTable');
            table.innerHTML = '';
            
            // حساب إجمالي المصروفات
            const totalExpenses = data.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('totalExpenses').textContent = formatNumber(totalExpenses);
            
            data.expenses.forEach(expense => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${expense.date}</td>
                    <td>${expense.type}</td>
                    <td class="currency">${formatNumber(expense.amount)}</td>
                    <td>${expense.notes || ''}</td>
                    <td>${expense.addLater ? '<span class="badge bg-warning">لاحقًا</span>' : '<span class="badge bg-success">مدفوع</span>'}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-warning edit-expense" data-id="${expense.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger delete-expense" data-id="${expense.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                table.appendChild(row);
            });
            
            // إضافة معالجات الأحداث للأزرار
            document.querySelectorAll('.edit-expense').forEach(btn => {
                btn.addEventListener('click', () => editExpense(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-expense').forEach(btn => {
                btn.addEventListener('click', () => deleteExpense(btn.dataset.id));
            });
        }
        
        // تحديث قائمة المحلات في التقارير
        function updateReportStores() {
            const select = document.getElementById('reportStoreSelect');
            // مسح الخيارات الحالية باستثناء "جميع المحلات"
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // إضافة المحلات
            data.stores.forEach(store => {
                const option = document.createElement('option');
                option.value = store.id;
                option.textContent = store.name;
                select.appendChild(option);
            });
        }
        
        // توليد تقرير الديون
        function generateDebtReport() {
            const table = document.getElementById('debtReportTable');
            table.innerHTML = '';
            
            // حساب إجمالي الديون
            const totalDebts = data.stores.reduce((sum, store) => {
                const storeSales = data.sales.filter(s => s.storeId === store.id);
                const storePayments = data.payments.filter(p => p.storeId === store.id);
                
                const totalSales = storeSales.reduce((s, sale) => s + sale.total, 0);
                const totalPayments = storePayments.reduce((p, payment) => p + payment.amount, 0);
                
                return sum + (totalSales - totalPayments);
            }, 0);
            
            document.getElementById('totalDebts').textContent = formatNumber(totalDebts);
            
            data.stores.forEach(store => {
                const storeSales = data.sales.filter(s => s.storeId === store.id);
                const storePayments = data.payments.filter(p => p.storeId === store.id);
                
                const totalSales = storeSales.reduce((sum, sale) => sum + sale.total, 0);
                const totalPayments = storePayments.reduce((sum, payment) => sum + payment.amount, 0);
                const remaining = totalSales - totalPayments;
                
                const lastSale = storeSales.length > 0 ? 
                    storeSales.reduce((latest, sale) => sale.date > latest ? sale.date : latest, '') : '';
                
                const lastPayment = storePayments.length > 0 ? 
                    storePayments.reduce((latest, payment) => payment.date > latest ? payment.date : latest, '') : '';
                
                const lastTransaction = lastSale > lastPayment ? lastSale : lastPayment;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${store.name}</td>
                    <td class="currency">${formatNumber(totalSales)}</td>
                    <td class="currency">${formatNumber(totalPayments)}</td>
                    <td class="currency ${remaining > 0 ? 'text-danger' : 'text-success'}">${formatNumber(Math.abs(remaining))}</td>
                    <td>${getPriceTypeName(store.priceType)}</td>
                    <td>${lastTransaction || 'لا يوجد'}</td>
                `;
                table.appendChild(row);
            });
        }
        
        // تصدير البيانات
        function exportData() {
            const dataType = document.getElementById('exportDataType').value;
            const format = document.getElementById('exportFormat').value;
            
            let exportData;
            let title = '';
            let filename = `تصدير_${dataType}_${moment().format('YYYYMMDD')}`;
            
            switch(dataType) {
                case 'packages':
                    exportData = data.packages;
                    title = 'الباقات والأسعار';
                    break;
                case 'inventory':
                    exportData = data.inventory;
                    title = 'كمية الكروت';
                    break;
                case 'stores':
                    exportData = data.stores;
                    title = 'البقالات والمحلات';
                    break;
                case 'expenses':
                    exportData = data.expenses;
                    title = 'المصروفات';
                    break;
                case 'sales':
                    exportData = data.sales;
                    title = 'المبيعات';
                    break;
                case 'payments':
                    exportData = data.payments;
                    title = 'التسديدات';
                    break;
                case 'reports':
                    exportData = {
                        debtReport: generateDebtReportData(),
                        profitReport: generateProfitReportData()
                    };
                    title = 'التقارير';
                    filename = `تقرير_${moment().format('YYYYMMDD')}`;
                    break;
                default:
                    exportData = data;
                    title = 'جميع البيانات';
                    filename = `نسخة_احتياطية_${moment().format('YYYYMMDD')}`;
            }
            
            if (format === 'json') {
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير البيانات إلى ملف JSON', 'success');
            } else if (format === 'excel') {
                // إنشاء ورقة عمل
                let wb;
                if (Array.isArray(exportData)) {
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, title);
                } else {
                    // كائن متعدد الأقسام (مثل التقارير)
                    wb = XLSX.utils.book_new();
                    Object.keys(exportData).forEach(key => {
                        const ws = XLSX.utils.json_to_sheet(exportData[key]);
                        XLSX.utils.book_append_sheet(wb, ws, key);
                    });
                }
                
                // تصدير إلى Excel
                XLSX.writeFile(wb, `${filename}.xlsx`);
                showNotification('تم تصدير البيانات إلى ملف Excel', 'success');
            } else if (format === 'txt') {
                // إنشاء نص بسيط
                let txtContent = `${title}\n\n`;
                txtContent += `تاريخ التصدير: ${moment().format('YYYY-MM-DD')}\n\n`;
                
                if (Array.isArray(exportData) && exportData.length > 0) {
                    // العناوين
                    const headers = Object.keys(exportData[0]).join('\t');
                    txtContent += headers + '\n';
                    
                    // البيانات
                    exportData.forEach(item => {
                        txtContent += Object.values(item).join('\t') + '\n';
                    });
                } else if (typeof exportData === 'object') {
                    // كائن متعدد الأقسام
                    Object.keys(exportData).forEach(key => {
                        txtContent += `\n===== ${key} =====\n\n`;
                        const section = exportData[key];
                        if (Array.isArray(section) && section.length > 0) {
                            const headers = Object.keys(section[0]).join('\t');
                            txtContent += headers + '\n';
                            section.forEach(item => {
                                txtContent += Object.values(item).join('\t') + '\n';
                            });
                        }
                    });
                }
                
                // تنزيل الملف
                const blob = new Blob([txtContent], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير البيانات إلى ملف TXT', 'success');
            }
        }

        // تصدير تفاصيل المحل
        function exportStoreData(storeId, format) {
            const store = data.stores.find(s => s.id === storeId);
            if (!store) return;
            
            const storeSales = data.sales.filter(s => s.storeId === storeId);
            const storePayments = data.payments.filter(p => p.storeId === storeId);
            
            const exportData = {
                store: store,
                sales: storeSales,
                payments: storePayments
            };
            
            const filename = `تفاصيل_${store.name.replace(/\s+/g, '_')}_${moment().format('YYYYMMDD')}`;
            
            if (format === 'json') {
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير بيانات المحل إلى ملف JSON', 'success');
            } else if (format === 'excel') {
                // إنشاء ورقة عمل
                const wb = XLSX.utils.book_new();
                
                // ورقة المحل
                const storeWs = XLSX.utils.json_to_sheet([store]);
                XLSX.utils.book_append_sheet(wb, storeWs, 'المحل');
                
                // ورقة المبيعات
                if (storeSales.length > 0) {
                    const salesWs = XLSX.utils.json_to_sheet(storeSales);
                    XLSX.utils.book_append_sheet(wb, salesWs, 'المبيعات');
                }
                
                // ورقة التسديدات
                if (storePayments.length > 0) {
                    const paymentsWs = XLSX.utils.json_to_sheet(storePayments);
                    XLSX.utils.book_append_sheet(wb, paymentsWs, 'التسديدات');
                }
                
                // تصدير إلى Excel
                XLSX.writeFile(wb, `${filename}.xlsx`);
                showNotification('تم تصدير بيانات المحل إلى ملف Excel', 'success');
            } else if (format === 'txt') {
                // إنشاء نص بسيط
                let txtContent = `تفاصيل المحل: ${store.name}\n\n`;
                txtContent += `تاريخ التصدير: ${moment().format('YYYY-MM-DD')}\n\n`;
                
                // تفاصيل المحل
                txtContent += "===== معلومات المحل =====\n\n";
                Object.keys(store).forEach(key => {
                    txtContent += `${key}: ${store[key]}\n`;
                });
                
                // المبيعات
                txtContent += "\n===== المبيعات =====\n\n";
                if (storeSales.length > 0) {
                    const headers = Object.keys(storeSales[0]).join('\t');
                    txtContent += headers + '\n';
                    storeSales.forEach(sale => {
                        txtContent += Object.values(sale).join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد مبيعات\n";
                }
                
                // التسديدات
                txtContent += "\n===== التسديدات =====\n\n";
                if (storePayments.length > 0) {
                    const headers = Object.keys(storePayments[0]).join('\t');
                    txtContent += headers + '\n';
                    storePayments.forEach(payment => {
                        txtContent += Object.values(payment).join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد تسديدات\n";
                }
                
                const blob = new Blob([txtContent], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير بيانات المحل إلى ملف TXT', 'success');
            }
        }

        // تصدير المصروفات
        function exportExpensesData(format) {
            const filename = `المصروفات_${moment().format('YYYYMMDD')}`;
            
            if (format === 'json') {
                const dataStr = JSON.stringify(data.expenses, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير المصروفات إلى ملف JSON', 'success');
            } else if (format === 'excel') {
                const ws = XLSX.utils.json_to_sheet(data.expenses);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "المصروفات");
                XLSX.writeFile(wb, `${filename}.xlsx`);
                showNotification('تم تصدير المصروفات إلى ملف Excel', 'success');
            } else if (format === 'txt') {
                let txtContent = "المصروفات\n\n";
                txtContent += `تاريخ التصدير: ${moment().format('YYYY-MM-DD')}\n\n`;
                
                if (data.expenses.length > 0) {
                    const headers = Object.keys(data.expenses[0]).join('\t');
                    txtContent += headers + '\n';
                    data.expenses.forEach(expense => {
                        txtContent += Object.values(expense).join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد مصروفات\n";
                }
                
                const blob = new Blob([txtContent], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير المصروفات إلى ملف TXT', 'success');
            }
        }

        // تصدير التقارير
        function exportReportsData(format) {
            const filename = `التقارير_${moment().format('YYYYMMDD')}`;
            const reportData = {
                debtReport: generateDebtReportData(),
                profitReport: generateProfitReportData(),
                partnerReport: generatePartnerReportData()
            };
            
            if (format === 'json') {
                const dataStr = JSON.stringify(reportData, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير التقارير إلى ملف JSON', 'success');
            } else if (format === 'excel') {
                const wb = XLSX.utils.book_new();
                
                // تقرير الديون
                if (reportData.debtReport.length > 0) {
                    const debtWs = XLSX.utils.json_to_sheet(reportData.debtReport);
                    XLSX.utils.book_append_sheet(wb, debtWs, "تقرير الديون");
                }
                
                // تقرير الأرباح
                if (reportData.profitReport.length > 0) {
                    const profitWs = XLSX.utils.json_to_sheet(reportData.profitReport);
                    XLSX.utils.book_append_sheet(wb, profitWs, "تقرير الأرباح");
                }
                
                // تقرير الشركاء
                if (reportData.partnerReport.length > 0) {
                    const partnerWs = XLSX.utils.json_to_sheet(reportData.partnerReport);
                    XLSX.utils.book_append_sheet(wb, partnerWs, "تقرير الشركاء");
                }
                
                XLSX.writeFile(wb, `${filename}.xlsx`);
                showNotification('تم تصدير التقارير إلى ملف Excel', 'success');
            } else if (format === 'txt') {
                let txtContent = "تقارير النظام\n\n";
                txtContent += `تاريخ التصدير: ${moment().format('YYYY-MM-DD')}\n\n`;
                
                // تقرير الديون
                txtContent += "===== تقرير الديون =====\n\n";
                if (reportData.debtReport.length > 0) {
                    const headers = Object.keys(reportData.debtReport[0]).join('\t');
                    txtContent += headers + '\n';
                    reportData.debtReport.forEach(report => {
                        txtContent += Object.values(report).join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد بيانات\n";
                }
                
                // تقرير الأرباح
                txtContent += "\n===== تقرير الأرباح =====\n\n";
                if (reportData.profitReport.length > 0) {
                    const headers = Object.keys(reportData.profitReport[0]).join('\t');
                    txtContent += headers + '\n';
                    reportData.profitReport.forEach(report => {
                        txtContent += Object.values(report).join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد بيانات\n";
                }
                
                // تقرير الشركاء
                txtContent += "\n===== تقرير الشركاء =====\n\n";
                if (reportData.partnerReport.length > 0) {
                    const headers = Object.keys(reportData.partnerReport[0]).join('\t');
                    txtContent += headers + '\n';
                    reportData.partnerReport.forEach(report => {
                        txtContent += Object.values(report).join('\t') + '\n';
                    });
                } else {
                    txtContent += "لا توجد بيانات\n";
                }
                
                const blob = new Blob([txtContent], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('تم تصدير التقارير إلى ملف TXT', 'success');
            }
        }

        // توليد بيانات تقرير الديون
        function generateDebtReportData() {
            return data.stores.map(store => {
                const storeSales = data.sales.filter(s => s.storeId === store.id);
                const storePayments = data.payments.filter(p => p.storeId === store.id);
                
                const totalSales = storeSales.reduce((sum, sale) => sum + sale.total, 0);
                const totalPayments = storePayments.reduce((sum, payment) => sum + payment.amount, 0);
                const remaining = totalSales - totalPayments;
                
                return {
                    'اسم المحل': store.name,
                    'إجمالي المبيعات': totalSales,
                    'المدفوع': totalPayments,
                    'المتبقي': remaining,
                    'نوع السعر': getPriceTypeName(store.priceType)
                };
            });
        }
        
        // توليد بيانات تقرير الأرباح
        function generateProfitReportData() {
            const totalSales = data.sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalExpenses = data.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const netProfit = totalSales - totalExpenses;
            
            return [{
                'إجمالي المبيعات': totalSales,
                'إجمالي المصروفات': totalExpenses,
                'صافي الربح': netProfit
            }];
        }
        
        // توليد بيانات تقرير الشركاء
        function generatePartnerReportData() {
            const fromDate = document.getElementById('reportFromDate').value || moment().startOf('month').format('YYYY-MM-DD');
            const toDate = document.getElementById('reportToDate').value || moment().format('YYYY-MM-DD');
            
            return [
                ...data.sales.filter(sale => sale.date >= fromDate && sale.date <= toDate).map(sale => ({
                    'النوع': 'بيع',
                    'المبلغ': sale.total,
                    'التفاصيل': sale.reason || (sale.packageId ? 'بيع باقة' : 'بيع مخصص'),
                    'التاريخ': sale.date
                })),
                ...data.expenses.filter(expense => expense.date >= fromDate && expense.date <= toDate).map(expense => ({
                    'النوع': 'مصروف',
                    'المبلغ': expense.amount,
                    'التفاصيل': expense.type,
                    'التاريخ': expense.date
                }))
            ];
        }

        // استيراد البيانات
        function importData() {
            const fileInput = document.getElementById('importFile');
            const replace = document.getElementById('replaceData').checked;
            const dataType = document.getElementById('importDataType').value;
            
            if (!fileInput.files.length) {
                showNotification('يرجى اختيار ملف للاستيراد', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (dataType === 'all') {
                        if (replace) {
                            data = importedData;
                        } else {
                            // دمج البيانات
                            data.packages = [...data.packages, ...importedData.packages];
                            data.inventory = [...data.inventory, ...importedData.inventory];
                            data.stores = [...data.stores, ...importedData.stores];
                            data.expenses = [...data.expenses, ...importedData.expenses];
                            data.sales = [...data.sales, ...importedData.sales];
                            data.payments = [...data.payments, ...importedData.payments];
                        }
                    } else {
                        if (replace) {
                            data[dataType] = importedData;
                        } else {
                            data[dataType] = [...data[dataType], ...importedData];
                        }
                    }
                    
                    saveData();
                    showNotification('تم استيراد البيانات بنجاح', 'success');
                    
                    // تحديث الواجهة
                    updateDashboard();
                    renderPackagesTable();
                    renderInventoryTable();
                    renderStoresList();
                    renderExpensesTable();
                    updateReportStores();
                    updateProfitReport();
                    generateDebtReport();
                    generatePartnerReports();
                    
                } catch (error) {
                    showNotification('خطأ في تحليل ملف JSON', 'error');
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
        }
        
        // إظهار الإشعارات
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.className = 'notification';
            }, 3000);
        }
        
        // تهيئة النظام عند التحميل
        document.addEventListener('DOMContentLoaded', function() {
            // تحميل البيانات
            loadData();
            
            // توليد تقارير
            generateDebtReport();
            generatePartnerReports();
            
            // تهيئة حقول الإدخال المنسقة
            setupFormattedInputs();
            
            // تغيير الأقسام
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const sections = document.querySelectorAll('.section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // إزالة النشطة من جميع الروابط
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // إضافة النشط للرابط الحالي
                    this.classList.add('active');
                    
                    // إخفاء جميع الأقسام
                    sections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    // إظهار القسم المحدد
                    const targetSection = this.getAttribute('data-section');
                    document.getElementById(targetSection).style.display = 'block';
                    
                    // تحديث عنوان الصفحة
                    document.querySelector('.page-title').textContent = this.textContent.trim();
                    
                    // إذا كان القسم هو التقارير، قم بتوليدها
                    if (targetSection === 'reports') {
                        generatePartnerReports();
                    }
                });
            });
            
            // إضافة معالجات الأحداث للأزرار
            document.getElementById('addPackageBtn').addEventListener('click', addPackage);
            document.getElementById('savePackageBtn').addEventListener('click', savePackage);
            
            document.getElementById('addInventoryBtn').addEventListener('click', addInventory);
            document.getElementById('saveInventoryBtn').addEventListener('click', saveInventory);
            
            document.getElementById('addStoreBtn').addEventListener('click', addStore);
            document.getElementById('saveStoreBtn').addEventListener('click', saveStore);
            
            document.getElementById('addExpenseBtn').addEventListener('click', addExpense);
            document.getElementById('saveExpenseBtn').addEventListener('click', saveExpense);
            
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                generateDebtReport();
                generatePartnerReports();
                showNotification('تم تحديث التقارير بنجاح', 'success');
            });
            
            document.getElementById('exportDataBtn').addEventListener('click', exportData);
            document.getElementById('importDataBtn').addEventListener('click', importData);
            
            document.getElementById('filterExpensesBtn').addEventListener('click', function() {
                showNotification('تم تطبيق تصفية المصروفات', 'success');
            });
            
            // إضافة معالجات الأحداث لأزرار التصدير العامة
            document.querySelectorAll('.export-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.dataset.type;
                    const format = this.dataset.format;
                    const storeId = this.dataset.store || '';
                    
                    if (type === 'expenses') {
                        exportExpensesData(format);
                    } else if (type === 'reports') {
                        exportReportsData(format);
                    } else if (type === 'store') {
                        exportStoreData(storeId, format);
                    }
                });
            });
            
            // معالجة أزرار الحفظ في نماذج البيع والتسديد
            document.getElementById('saveSaleBtn').addEventListener('click', saveSale);
            document.getElementById('savePaymentBtn').addEventListener('click', savePayment);
            
            // تعيين تاريخ اليوم كافتراضي لحقول التاريخ
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
        });
    </script>
</body>
</html>